import{a as o,b as c}from"./chunk-JIQYLXCT.js";import{B as g,K as d,Wa as v,gb as k,j as a,lb as A,m as n,o as p,q as f,r as i,s as m,t as S,u as T,v as l,y as b}from"./chunk-MV26KPO3.js";var y=class u{constructor(e,t){this.http=e;this.router=t;this.checkTokenExpiration()}accessTokenKey=c.accessToken;refreshTokenKey=c.refreshToken;userKey=c.user;isAuthenticatedSubject=new a(this.hasValidToken());isAuthenticated$=this.isAuthenticatedSubject.asObservable();userSubject=new a(this.getUserFromStorage());user$=this.userSubject.asObservable();isAuthenticated=d(this.hasValidToken());currentUser=d(this.getUserFromStorage());isAdmin=v(()=>this.currentUser()?.role==="Admin");refreshInProgress=!1;refreshTokenSubject=new a(null);forgotPassword(e){let t={email:e};return this.http.post(`${o.baseUrl}${o.endpoints.auth.forgotPassword}`,t)}identifyUserType(e){return this.http.get(`${o.baseUrl}${o.endpoints.auth.identifyUserType}`,{params:{email:e}})}login(e,t){return console.log(`[AuthService.login] Iniciando login para email: '${e}'`),this.identifyUserType(e).pipe(T(r=>(console.log("[AuthService.login] IdentifyUserType retornou:",r),r.exists?r.userType==="Admin"?(console.log("[AuthService.login] Identificado como Admin, chamando loginAdmin"),this.loginAdmin(e,t)):r.userType==="User"?(console.log("[AuthService.login] Identificado como User, chamando loginUsuario"),this.loginUsuario(e,t)):(console.error(`[AuthService.login] Tipo de usu\xE1rio desconhecido: '${r.userType}'`),n(()=>new Error(`Tipo de usu\xE1rio desconhecido: ${r.userType}`))):(console.error("[AuthService.login] Email n\xE3o encontrado no sistema"),n(()=>new Error("Email n\xE3o encontrado no sistema"))))),i(r=>(console.error("[AuthService.login] ERRO no processo de login:",r),n(()=>r))))}loginAdmin(e,t,r=!1){let h={email:e,senha:t};return this.http.post(`${o.baseUrl}${o.endpoints.auth.loginAdmin}`,h).pipe(l(s=>this.handleLoginSuccess(s)),i(s=>(r||console.error("Erro no login admin:",s),n(()=>s))))}loginUsuario(e,t,r=!1){let h={email:e,senha:t};return this.http.post(`${o.baseUrl}${o.endpoints.auth.loginUsuario}`,h).pipe(l(s=>this.handleLoginSuccess(s)),i(s=>(r||console.error("Erro no login usu\xE1rio:",s),n(()=>s))))}handleLoginSuccess(e){localStorage.setItem(this.accessTokenKey,e.accessToken),e.refreshToken&&localStorage.setItem(this.refreshTokenKey,e.refreshToken);let t={userId:e.userId,email:e.email,role:e.role};localStorage.setItem(this.userKey,JSON.stringify(t)),this.updateAuthState(!0,t),this.redirectAfterLogin(t.role)}redirectAfterLogin(e){this.router.navigate(["/"])}logout(){console.log("[AuthService.logout] Iniciando logout"),this.clearAuthState(),console.log("[AuthService.logout] Estado limpo. Redirecionando para home..."),this.router.navigate(["/"]).then(()=>{console.log("[AuthService.logout] Logout conclu\xEDdo")})}logoutWithoutRedirect(){this.clearAuthState()}getAccessToken(){return localStorage.getItem(this.accessTokenKey)}getRefreshToken(){return localStorage.getItem(this.refreshTokenKey)}hasValidToken(){let e=this.getAccessToken();if(!e)return!1;try{let r=JSON.parse(atob(e.split(".")[1])).exp*1e3;return Date.now()<r}catch{return!1}}checkTokenExpiration(){this.hasValidToken()||this.clearAuthState()}clearAuthState(){console.log("[AuthService.clearAuthState] Limpando estado de autentica\xE7\xE3o..."),localStorage.removeItem(this.accessTokenKey),localStorage.removeItem(this.refreshTokenKey),localStorage.removeItem(this.userKey);let e=localStorage.getItem(this.accessTokenKey),t=localStorage.getItem(this.refreshTokenKey),r=localStorage.getItem(this.userKey);e||t||r?(console.warn("[AuthService.clearAuthState] AVISO: Alguns dados n\xE3o foram limpos corretamente!"),console.warn(`Token: ${e?"EXISTE":"OK"}, RefreshToken: ${t?"EXISTE":"OK"}, User: ${r?"EXISTE":"OK"}`)):console.log("[AuthService.clearAuthState] Estado limpo com sucesso"),this.updateAuthState(!1,null)}getUserFromStorage(){let e=localStorage.getItem(this.userKey);if(!e)return null;try{return JSON.parse(e)}catch{return null}}updateAuthState(e,t){this.isAuthenticated.set(e),this.currentUser.set(t),this.isAuthenticatedSubject.next(e),this.userSubject.next(t)}isLoggedIn(){return this.isAuthenticated()}isUserAdmin(){return this.isAdmin()}getCurrentUser(){return this.currentUser()}setAccessToken(e){localStorage.setItem(this.accessTokenKey,e)}refreshAccessToken(){let e=this.getRefreshToken();return e?this.refreshInProgress?this.refreshTokenSubject.pipe(f(t=>t!==null),m(1)):(this.refreshInProgress=!0,this.refreshTokenSubject.next(null),this.http.post(`${o.baseUrl}${o.endpoints.auth.refreshToken}`,{refreshToken:e}).pipe(l(t=>{this.setAccessToken(t.accessToken),t.refreshToken&&localStorage.setItem(this.refreshTokenKey,t.refreshToken),this.refreshTokenSubject.next(t.accessToken),this.updateAuthState(!0,this.currentUser())}),p(t=>t.accessToken),i(t=>(this.refreshTokenSubject.next(null),this.logout(),n(()=>t))),S(()=>{this.refreshInProgress=!1}))):n(()=>new Error("Refresh token n\xE3o encontrado"))}static \u0275fac=function(t){return new(t||u)(g(k),g(A))};static \u0275prov=b({token:u,factory:u.\u0275fac,providedIn:"root"})};export{y as a};
