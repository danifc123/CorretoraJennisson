<div class="admin-imoveis-page">
  <!-- Header -->
  <div class="page-header">
    <div class="header-content">
      <div>
        <h1>Gerenciar Imóveis</h1>
        <p>Adicione, edite e exclua imóveis do sistema</p>
      </div>
      <button type="button"
              class="btn-primary"
              (click)="novoImovel()"
              [disabled]="loading() || showForm()">
        <span class="material-icons">add</span>
        Novo Imóvel
      </button>
    </div>
  </div>

  <!-- Mensagens -->
  @if (successMessage()) {
  <div class="alert alert-success" role="alert">
    <span class="material-icons">check_circle</span>
    <p>{{ successMessage() }}</p>
  </div>
  }

  @if (errorMessage()) {
  <div class="alert alert-error" role="alert">
    <span class="material-icons">error</span>
    <p>{{ errorMessage() }}</p>
  </div>
  }

  <!-- Formulário de Criação/Edição -->
  @if (showForm()) {
  <div class="form-section">
    <div class="form-header">
      <h2>{{ editingImovel() ? 'Editar Imóvel' : 'Novo Imóvel' }}</h2>
      <button type="button"
              class="btn-close"
              (click)="cancelar()"
              [disabled]="loading()"
              aria-label="Fechar formulário">
        <span class="material-icons">close</span>
      </button>
    </div>

    <form class="admin-form" (ngSubmit)="salvarImovel()">
      <!-- Informações Básicas -->
      <div class="form-section-title">
        <span class="material-icons">info</span>
        Informações Básicas
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="titulo">
            <span class="material-icons">title</span>
            Título do Imóvel *
          </label>
          <input type="text"
                 id="titulo"
                 [(ngModel)]="formData.titulo"
                 name="titulo"
                 placeholder="Ex: Casa moderna com 3 quartos"
                 [disabled]="loading()"
                 required />
        </div>

        <div class="form-group">
          <label for="tipoImovel">
            <span class="material-icons">home</span>
            Tipo *
          </label>
          <input type="text"
                 id="tipoImovel"
                 name="tipoImovel"
                 list="tiposImovel"
                 class="type-input"
                 [(ngModel)]="formData.tipoImovel"
                 [disabled]="loading()"
                 placeholder="Ex: Casa"
                 autocomplete="off"
                 required
                 title="Digite o tipo do imóvel"
                 aria-label="Tipo de imóvel" />
          <datalist id="tiposImovel">
            <option *ngFor="let tipo of tipos()" [value]="tipo"></option>
          </datalist>
          <small class="field-hint">Digite um novo tipo ou selecione um existente</small>
        </div>

        <div class="form-group">
          <label for="status">
            <span class="material-icons">info</span>
            Status *
          </label>
          <select id="status"
                  [(ngModel)]="formData.status"
                  name="status"
                  [disabled]="loading()"
                  required
                  title="Selecione o status do imóvel"
                  aria-label="Status do imóvel">
            <option *ngFor="let status of statusOptions" [value]="status">{{ status }}</option>
          </select>
        </div>

        <div class="form-group toggle-field">
          <label>
            <span class="material-icons">{{ formData.ativo === false ? 'visibility_off' : 'visibility' }}</span>
            Visibilidade *
          </label>
          <div class="toggle-control">
            <label class="switch" aria-label="Visibilidade do imóvel">
              <input type="checkbox"
                     name="ativo"
                     [(ngModel)]="formData.ativo"
                     [disabled]="loading()" />
              <span class="slider"></span>
            </label>
            <span class="toggle-text">
              {{ formData.ativo === false ? 'Desabilitado para clientes' : 'Habilitado para clientes' }}
            </span>
          </div>
          <small class="field-hint">Desabilite para ocultar temporariamente este imóvel no site.</small>
        </div>
      </div>

      <!-- Localização -->
      <div class="form-section-title">
        <span class="material-icons">location_on</span>
        Localização
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="estado">
            <span class="material-icons">map</span>
            Estado *
          </label>
          <select id="estado"
                  [(ngModel)]="formData.estado"
                  name="estado"
                  [disabled]="loading()"
                  required
                  title="Selecione o estado"
                  aria-label="Estado">
            <option *ngFor="let estado of estados" [value]="estado">{{ estado }}</option>
          </select>
        </div>

        <div class="form-group">
          <label for="cidade">
            <span class="material-icons">location_city</span>
            Cidade *
          </label>
          <input type="text"
                 id="cidade"
                 [(ngModel)]="formData.cidade"
                 name="cidade"
                 placeholder="Ex: João Pessoa"
                 [disabled]="loading()"
                 required />
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="endereco">
            <span class="material-icons">place</span>
            Endereço *
          </label>
          <input type="text"
                 id="endereco"
                 [(ngModel)]="formData.endereco"
                 name="endereco"
                 placeholder="Ex: Rua das Flores, 123 - Bairro"
                 [disabled]="loading()"
                 required />
        </div>
      </div>

      <!-- Características -->
      <div class="form-section-title">
        <span class="material-icons">room_preferences</span>
        Características
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="preco">
            <span class="material-icons">attach_money</span>
            Preço (R$) *
          </label>
          <input type="number"
                 id="preco"
                 [(ngModel)]="formData.preco"
                 name="preco"
                 placeholder="0"
                 min="0"
                 step="0.01"
                 [disabled]="loading()"
                 required />
        </div>
      </div>

      <!-- Cômodos -->
      <div class="form-section-title">
        <span class="material-icons">home</span>
        Cômodos (Opcional)
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="salas">
            <span class="material-icons">living</span>
            Salas
          </label>
          <input type="number"
                 id="salas"
                 [(ngModel)]="formData.salas"
                 name="salas"
                 placeholder="0"
                 min="0"
                 [disabled]="loading()" />
        </div>

        <div class="form-group">
          <label for="cozinhas">
            <span class="material-icons">kitchen</span>
            Cozinhas
          </label>
          <input type="number"
                 id="cozinhas"
                 [(ngModel)]="formData.cozinhas"
                 name="cozinhas"
                 placeholder="0"
                 min="0"
                 [disabled]="loading()" />
        </div>

        <div class="form-group">
          <label for="banheiros">
            <span class="material-icons">bathroom</span>
            Banheiros
          </label>
          <input type="number"
                 id="banheiros"
                 [(ngModel)]="formData.banheiros"
                 name="banheiros"
                 placeholder="0"
                 min="0"
                 [disabled]="loading()" />
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="suites">
            <span class="material-icons">bed</span>
            Suítes
          </label>
          <input type="number"
                 id="suites"
                 [(ngModel)]="formData.suites"
                 name="suites"
                 placeholder="0"
                 min="0"
                 [disabled]="loading()" />
        </div>

        <div class="form-group">
          <label for="lavabos">
            <span class="material-icons">wc</span>
            Lavabos
          </label>
          <input type="number"
                 id="lavabos"
                 [(ngModel)]="formData.lavabos"
                 name="lavabos"
                 placeholder="0"
                 min="0"
                 [disabled]="loading()" />
        </div>

        <div class="form-group">
          <label for="garagemDescoberta">
            <span class="material-icons">garage</span>
            Garagem Descoberta
          </label>
          <input type="number"
                 id="garagemDescoberta"
                 [(ngModel)]="formData.garagemDescoberta"
                 name="garagemDescoberta"
                 placeholder="0"
                 min="0"
                 [disabled]="loading()" />
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="garagemCoberta">
            <span class="material-icons">garage</span>
            Garagem Coberta
          </label>
          <input type="number"
                 id="garagemCoberta"
                 [(ngModel)]="formData.garagemCoberta"
                 name="garagemCoberta"
                 placeholder="0"
                 min="0"
                 [disabled]="loading()" />
        </div>
      </div>

      <!-- Descrição -->
      <div class="form-section-title">
        <span class="material-icons">description</span>
        Descrição
      </div>

      <div class="form-group">
        <label for="descricao">
          <span class="material-icons">text_fields</span>
          Descrição do Imóvel *
        </label>
        <textarea id="descricao"
                  [(ngModel)]="formData.descricao"
                  name="descricao"
                  rows="5"
                  placeholder="Descreva as características e benefícios do imóvel..."
                  [disabled]="loading()"
                  required></textarea>
      </div>

      <!-- Imagens -->
      <div class="form-section-title">
        <span class="material-icons">image</span>
        Imagens do Imóvel
      </div>

      <div class="form-group">
        <label for="imagens">
          <span class="material-icons">photo_library</span>
          Adicionar Imagens
        </label>
        <input #fileInput
               type="file"
               id="imagens"
               name="imagens"
               accept="image/*"
               multiple
               (change)="onImageSelect($event)"
               [disabled]="loading()"
               class="file-input-hidden" />
        <button type="button"
                class="btn-upload"
                (click)="abrirSeletorImagens()"
                [disabled]="loading()">
          <span class="material-icons">cloud_upload</span>
          Selecionar Imagens
        </button>
        <small class="field-hint">Você pode selecionar múltiplas imagens (máximo recomendado: 10)</small>
      </div>

      <!-- Imagens Existentes (ao editar) -->
      @if (imagensExistentes().length > 0 && editingImovel()) {
      <div class="images-section">
        <h4>Imagens Existentes</h4>
        <div class="images-preview">
          @for (img of imagensExistentes(); track $index; let i = $index) {
          <div class="image-preview-item">
            <img [src]="img"
                 [alt]="'Imagem existente ' + (i + 1)"
                 title="Imagem existente" />
            @if (podeDeletarImagem(i)) {
            <button type="button"
                    class="btn-remove-image"
                    (click)="deletarImagem(editingImovel()!.id, getImagemId(i)!, i)"
                    [disabled]="loading()"
                    aria-label="Remover imagem">
              <span class="material-icons">close</span>
            </button>
            }
          </div>
          }
        </div>
      </div>
      }

      <!-- Preview das Novas Imagens -->
      @if (imagensPreview().length > 0) {
      <div class="images-section">
        <h4>Novas Imagens (Preview)</h4>
        <div class="images-preview">
          @for (img of imagensPreview(); track $index) {
          <div class="image-preview-item">
            <img [src]="img"
                 [alt]="'Preview imagem ' + ($index + 1)"
                 title="Preview imagem" />
            <button type="button"
                    class="btn-remove-image"
                    (click)="removerImagemPreview($index)"
                    [disabled]="loading() || uploadingImages()"
                    aria-label="Remover imagem">
              <span class="material-icons">close</span>
            </button>
          </div>
          }
        </div>
      </div>
      }

      <!-- Botões de Ação -->
      <div class="form-actions">
        <button type="button"
                class="btn-secondary"
                (click)="cancelar()"
                [disabled]="loading()">
          Cancelar
        </button>
        <button type="submit"
                class="btn-primary"
                [disabled]="loading()">
          @if (loading()) {
          <span class="spinner"></span>
          <span>Salvando...</span>
          } @else {
          <span class="material-icons">save</span>
          <span>{{ editingImovel() ? 'Atualizar' : 'Criar' }} Imóvel</span>
          }
        </button>
      </div>
    </form>
  </div>
  }

  <!-- Filtros e Busca -->
  <div class="filters-bar">
    <div class="search-box">
      <span class="material-icons">search</span>
      <input type="text"
             placeholder="Buscar imóveis..."
             [(ngModel)]="searchTerm"
             (ngModelChange)="searchTerm.set($any($event))" />
    </div>

    <select class="filter-select"
            [(ngModel)]="tipoFiltro"
            (ngModelChange)="tipoFiltro.set($any($event))"
            title="Filtrar por tipo"
            aria-label="Filtrar por tipo">
      <option value="">Todos os tipos</option>
      <option *ngFor="let tipo of tipos()" [value]="tipo">{{ tipo }}</option>
    </select>

    <select class="filter-select"
            [(ngModel)]="statusFiltro"
            (ngModelChange)="statusFiltro.set($any($event))"
            title="Filtrar por status"
            aria-label="Filtrar por status">
      <option value="">Todos os status</option>
      <option *ngFor="let status of statusOptions" [value]="status">{{ status }}</option>
    </select>
  </div>

  <!-- Lista de Imóveis -->
  <div class="imoveis-list">
    @if (imoveisFiltrados().length > 0) {
    <div class="imoveis-grid">
      @for (imovel of imoveisFiltrados(); track imovel.id) {
      <div class="imovel-item" [class.imovel-inativo]="imovel.ativo === false">
        <!-- Imagem -->
        <div class="imovel-item-image">
          @if (imovel.imagens && imovel.imagens.length > 0) {
          <img [src]="imovel.imagens[0].url"
               [alt]="imovel.titulo"
               title="Imagem do imóvel"
               [attr.title]="imovel.titulo" />
          } @else {
          <div class="no-image">
            <span class="material-icons">image_not_supported</span>
            <p>Sem imagem</p>
          </div>
          }
          <span class="imovel-status-chip" [class.inactive]="imovel.ativo === false">
            <span class="material-icons">{{ imovel.ativo === false ? 'visibility_off' : 'visibility' }}</span>
            {{ imovel.ativo === false ? 'Desabilitado' : 'Habilitado' }}
          </span>
        </div>

        <!-- Informações -->
        <div class="imovel-item-info">
          <h3>{{ imovel.titulo }}</h3>
          <p class="imovel-location">
            <span class="material-icons">location_on</span>
            {{ imovel.endereco }}, {{ imovel.cidade }} - {{ imovel.estado }}
          </p>

          <div class="imovel-features">
            <span><span class="material-icons">home</span> {{ imovel.tipoImovel }}</span>
            <span><span class="material-icons">info</span> {{ imovel.status }}</span>
          </div>

          <div class="imovel-price">{{ formatarPreco(imovel.preco) }}</div>
        </div>

        <!-- Ações -->
        <div class="imovel-item-actions">
          <button type="button"
                  class="btn-action btn-toggle"
                  (click)="toggleAtivo(imovel)"
                  [disabled]="loading()"
                  [title]="imovel.ativo === false ? 'Habilitar imóvel' : 'Desabilitar imóvel'"
                  aria-label="Alterar visibilidade do imóvel">
            <span class="material-icons">{{ imovel.ativo === false ? 'toggle_on' : 'toggle_off' }}</span>
            {{ imovel.ativo === false ? 'Habilitar' : 'Desabilitar' }}
          </button>
          <button type="button"
                  class="btn-action btn-edit"
                  (click)="editarImovel(imovel)"
                  [disabled]="loading()"
                  title="Editar imóvel"
                  aria-label="Editar imóvel">
            <span class="material-icons">edit</span>
          </button>
          <button type="button"
                  class="btn-action btn-delete"
                  (click)="deletarImovel(imovel)"
                  [disabled]="loading()"
                  title="Excluir imóvel"
                  aria-label="Excluir imóvel">
            <span class="material-icons">delete</span>
          </button>
        </div>
      </div>
      }
    </div>
    } @else {
    <div class="empty-state">
      <span class="material-icons">home_work</span>
      <h3>Nenhum imóvel encontrado</h3>
      <p>{{ searchTerm() || tipoFiltro() ? 'Tente ajustar os filtros.' : 'Comece adicionando seu primeiro imóvel.' }}</p>
      @if (!searchTerm() && !tipoFiltro()) {
      <button type="button"
              class="btn-primary"
              (click)="novoImovel()">
        <span class="material-icons">add</span>
        Adicionar Primeiro Imóvel
      </button>
      }
    </div>
    }
  </div>
</div>

